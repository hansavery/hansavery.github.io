<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HansAvery.com</title>
</head>
<body>
    <h1 id="header">Hans Avery</h1>

    <div id="tblcontainer">
        <table id="tbl"></table>
    </div>
</body>
<style>
    body {margin: 0; overflow: hidden;}
    h1 {font-family: sans-serif;}
    h1 div {display: inline; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;}


    #tblcontainer {position: relative; overflow: scroll; height: 80vh; width: 100%;}
    table {position: relative; border-collapse: collapse; border: 0.5px solid black; font-family: sans-serif; white-space: nowrap; line-height: 1.4em;} /* line height less than row height below but similar (or at least bigger than 1em?) to ensure text is centered correctly */
    td {text-align: center; padding: 0; min-width: 2.5em;}
    th {text-align: center; padding: 0;}
    .goal {background-color: lightblue;}


    .cell {border: 0.5px solid gray;}
    .rowLabel {
        background-color: lightgray;
        border-color: black;
        border-style: solid;
        border-width: 0.5px 1px;
    }
    .colLabel {
        background-color: lightgray;
        border-color: black;
        border-style: solid;
        border-width: 1px 0.5px;
    }
    .corner {
        background-color: lightgray;
        border-color: black; 
        border-style: solid; 
        border-width: 1px;
    }

    thead th {
        position: -webkit-sticky; /* for Safari */
        position: sticky;
        top: 0;
    }

    th.corner {
        left: 0;
        z-index: 1;
    }

    tbody th {
        position: -webkit-sticky; /* for Safari */
        position: sticky;
        left: 0;
    }


    .selected {background-color: green;}
    .rowLabel.selected {background-color: darkgray;}
    .colLabel.selected {background-color: darkgray;}


    /* div {
  max-width: 40em;
  max-height: 20em;
  overflow: scroll;
  position: relative;
}

thead th {
  position: -webkit-sticky;
  position: sticky;
  top: 0;
  background: #000;
  color: #FFF;
}

thead th:first-child {
  left: 0;
  z-index: 1;
}

tbody th {
  position: -webkit-sticky;
  position: sticky;
  left: 0;
  background: #FFF;
  border-right: 1px solid #CCC;
} */



</style>
<script src="./levels.js"></script>
<script>


//-- state

function Game(sheet) {
    this.sheet = sheet;
};


Game.prototype.createClickHandler = function() {
    self = this;
    return function (event) {
        if (!event.target || event.target.nodeName !== 'TD')
            return;
        if (event.shift) {
            alert('not implemented yet')    
        }
        else {
            if (event.target.classList.contains('rowLabel'))
                selectRow(event.target);
            else if (event.target.classList.contains('colLabel'))
                selectCol(event.target);
            else
                self.sheet.selectCell(event.target);
        }
    };
};


Game.prototype.createKeyHandler = function() {
    self = this;
    directions = ['ArrowLeft', 'ArrowUp', 'ArrowRight', 'ArrowDown']
    return function keyHandler(event) {
        event = event || window.event;
        let key = event.key;
        if (directions.indexOf(key) !== -1) {
            let moveType = event.ctrlKey ? 'skip' : 'step';
            self.sheet.moveSelection(key, moveType);
            event.preventDefault();
            event.stopPropagation();
        }
        else if (key === 'Delete') {
            self.sheet.selected.innerText = '';
            event.preventDefault();
            event.stopPropagation();
        }
        else if (key.length === 1 && !event.ctrlKey &&
                 (  ('a' <= key && key <= 'z') ||
                    ('A' <= key && key <= 'Z') ||
                    ('0' <= key && key <= '9'))){
            self.sheet.selected.innerText = key;
            event.preventDefault();
            event.stopPropagation();
        }
    };
};


//--------fundef



function Sheet() {
    this.width = 100;
    this.height = 100;
    this.cells = null;
    this.selected = null;
    this.x = null;
    this.y = null;
    this.rowLabels = null;
    this.colLabels = null;
    this.corner = null;
}

Sheet.prototype.moveSelection = function(direction, moveType) {
    let x = this.x;
    let y = this.y;
    let incrementX = 0;
    let incrementY = 0;
    if (direction === 'ArrowUp')
        incrementY = -1;
    else if (direction === 'ArrowDown')
        incrementY = 1;
    else if (direction === 'ArrowLeft')
        incrementX = -1;
    else if (direction === 'ArrowRight')
        incrementX = 1;
    x += incrementX;
    y += incrementY;

    let startIsFilled = (this.selected.innerText !== '');
    let lastCell = this.selected;
    let nextCell = y < this.height && x< this.width && this.cells[y][x];
    let nextIsFilled = (nextCell && nextCell.innerText !== '');
    let stopCondition = !(startIsFilled && nextIsFilled);

    let numberOfSteps = (moveType === 'skip' ? -1 : 1);
    let stepsTaken = 0;

    while (nextCell) {
        // check steps within the loop in case we can't take a step w/o being OOB
        stepsTaken += 1;
        if (stepsTaken === numberOfSteps)
            break;
        
        nextIsFilled = (nextCell.innerText !== '');
        if (nextIsFilled === stopCondition) {
            if (!stopCondition) // if stoppiing at end of filled row, clear nextCell so that lastCell is selected
                nextCell = null;
            break;
        }

        x += incrementX;
        y += incrementY;
        lastCell = nextCell;
        nextCell = 0 <= y && y < this.height && 0 <= x && x < this.width && this.cells[y][x];
    }
    this.selectCell(nextCell || lastCell); // use the last if the next is undeifed
};


Sheet.prototype.selectCell = function(cell) {
    if (cell === this.selected)
        return;
    else if (this.selected) {
        this.selected.classList.remove('selected');
        this.rowLabels[this.y].classList.remove('selected');
        this.colLabels[this.x].classList.remove('selected');
    }
    cell.classList.add('selected');
    this.selected = cell;
    coordinates = cell.id.split(',');
    this.x = parseInt(coordinates[0] - 1);
    this.y = parseInt(coordinates[1] - 1);
    this.rowLabels[this.y].classList.add('selected')
    this.colLabels[this.x].classList.add('selected')
    cell.scrollIntoView({behavior: 'auto', block: 'center', inline: 'center'});
    if (this.selected.classList.contains('goal'))
        alert('you win!');
};


Sheet.prototype.loadMap = function(map) {
    for (let i = 0; i < map.length && i < this.cells.length; i++)
        for (let j = 0; j < map[i].length && j < this.cells[i].length; j++) {
            val = (map[i][j] === ' ' ? '' : map[i][j]);
            this.cells[i][j].innerText = val;
            if (val === 'X')
                this.cells[i][j].classList.add('goal');
        }
};




Sheet.prototype.makeGrid = function(tbl) {
    this.cells = [];
    this.colLabels = [];
    this.rowLabels = [];
    
    // make header
    let header = document.createElement('thead');
    tbl.appendChild(header);
    let rowEl = document.createElement('tr');

    // top corner
    let cellEl = getCell('th', 0, 0, this.rowHeights[0], this.colWidths[0], 'corner', ' ');
    rowEl.appendChild(cellEl);
    this.corner = cellEl

    // rest of header row
    for (let h = 1; h < this.width + 1; h++) {
        cellEl = getCell('th', h, 0, this.rowHeights[0], this.colWidths[h], 'colLabel', getLetterCode(h));
        rowEl.appendChild(cellEl);
        this.colLabels.push(cellEl);
    }
    header.appendChild(rowEl);
    
    // data rows
    let body = document.createElement('tbody');
    tbl.appendChild(body)
    for (let i = 1; i < this.height + 1; i++) {
        rowEl = document.createElement('tr');
        
        // make row header
        cellEl = getCell('th', 0, i, this.rowHeights[i], this.colWidths[0], 'rowLabel', i);
        rowEl.appendChild(cellEl);
        this.rowLabels.push(cellEl);

        // fill row
        let row = []
        for (let j = 1; j < this.width + 1; j++) {
            cellEl = getCell('td', j, i, this.rowHeights[i], this.colWidths[j], 'cell', '');
            rowEl.appendChild(cellEl);
            row.push(cellEl);
        }

        body.appendChild(rowEl);
        this.cells.push(row);
    }        
};



//--------- no globals

    function getCell(type, h, v, height, width, cssClass, text) {
        let cellEl = document.createElement(type);
        cellEl.style.minheight = height;
        cellEl.style.minwidth = width;
        cellEl.id = h + ',' + v
        cellEl.classList.add(cssClass);
        cellEl.innerText = text;
        return cellEl;
    }


    function getLetterCode(num) {
        let code = [];
        let remaining = num;
        while (remaining > 0) {
            let nextChar = ((remaining - 1) % 26) + 1;
            remaining = (remaining - nextChar) / 26;
            code.push(String.fromCharCode(64 + nextChar));
        }
        code.reverse();
        return code.join('');
    }








    let headEl = document.getElementById("header");
    let headText = headEl.innerText.split('');
    headEl.innerText = "";
    let chars = headText.map(function(v, i, a) {
        let s = document.createElement('div');
        s.innerText = v;
        headEl.appendChild(s);
        return s;
    });


    let sheet = new Sheet();
    var tbl = document.getElementById('tbl');
    sheet.rowHeights = new Array(sheet.height + 1).fill('1.5em');
    sheet.colWidths = new Array(sheet.width + 1).fill('2.5em');
    sheet.makeGrid(tbl);
    sheet.loadMap(LEVELS[0]);
    sheet.selectCell(sheet.cells[0][0]);


    let sheetGame = new Game(sheet);
    tbl.onclick = sheetGame.createClickHandler();
    window.addEventListener('keydown', sheetGame.createKeyHandler(), false);






</script>
</html>